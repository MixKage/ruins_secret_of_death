# Ruins: Secret Of Death (Telegram Bot)

Телеграм-игра в жанре текстового рогалика. Один забег = одна попытка до смерти.
Цель — пройти как можно больше этажей руин и занять место в рейтинге.

## Ключевые механики
- Случайное стартовое оружие 0 этажа, малое зелье и ледяной свиток.
- Каждая новая лестница — случайная группа врагов с характеристиками текущего этажа.
- Бой пошаговый: враги отвечают после завершения вашего хода.
- Очки действия (ОД): тратятся на атаки/умения, полностью восстанавливаются кнопкой "Завершить ход".
- Максимум ОД ограничен по этажам: 1–9 = 4, 10–19 = 6, 20–29 = 8 (далее +2 каждые 10 этажей).
- В бою доступны атака (1 ОД) и атака на все ОД; свитки и зелья также тратят 1 ОД.
- Максимальные запасы зелий: малые 10, средние 5, сильные 2.
- Между этажами здоровье полностью восстанавливается только в источнике; оружие усиливается только при выборе награды.
- Комнаты между этажами: источник благодати (полный хил; после 50 — малое зелье; для Палача вместо него — Камера Дознания с 1 средней вытяжкой мученика, после 50 — 2), сундук древних (шанс награды на +2 этажа, можно экипировать/оставить; даёт малое зелье, после 50 — ещё среднее), костер паломника (+2-3 к макс. HP; даёт малое зелье, после 50 — ещё среднее).
- Комнаты "Сундук древних" и "Костер паломника" не повторяются дважды подряд; источник благодати может выпадать подряд.
- Лимиты брони и уклонения: до 50 этажа броня ≤ 4 и уклонение ≤ 40%, до 100 этажа — броня ≤ 6 и уклонение ≤ 80%.
- Лишние зелья при переполнении инвентаря сгорают.
- Перед каждым боссом — выбор артефакта (Печать ярости, Печать воли, Алхимический набор: 2 средних зелья + случайный свиток) и полное восстановление HP/ОД.
- Печать ярости даёт +2 к урону, Печать воли — +1 к макс. ОД.
- После 50 этажа комнаты дают больше зелий, а обычные враги переживают полный ход героя.
- После 10 этажа враги мутируют, с 50 — становятся <b>Оскверненными</b>; элиты появляются с 50 этажа и имеют префикс <b>Проклятый</b>.
- Проклятые этажи (50+): шанс 20%, ОД снижены до 3/4.
- Оружие может иметь эффекты (сплэш-урон по группе, кровотечение, бронебойные удары).
- После 10 этажа оружие получает бонусы редкости (урон/точность/эффекты) и префикс в названии.
- Свитки магии добываются в сундуках (молния — с 15 этажа), тратят 1 ОД и игнорируют броню.
- Боссы: Некромант (10 этаж), Павший герой (каждые 10 этажей после 10, кроме кратных 50), Дочь некроманта (каждые 50 этажей).
- Награда за Павшего героя — сильное зелье и +5 к макс. HP; за Дочь некроманта — +5 к макс. HP, пополнение зелий до половины, свиток молнии и +10 XP.
- Базовая удача 20%; амулет удачи даёт +5% (макс. 70%).
- Рейтинг сезонный, обновляется каждый месяц; награды и опыт сохраняются в профиле.
- Испытания руин обновляются каждые 12 часов (UTC): 3 задачи на один забег, каждая даёт +20 XP.
- Новые герои открываются каждые 5 уровней (Рыцарь доступен сразу).

## Игровые персонажи

### Рыцарь
- Сбалансированный герой без особых эффектов.
- Последнее издыхание: при HP ≤ 1/3 точность 100%.
- Решимость: на полном здоровье урон +20%.

### Страж рун
- HP +6, броня +1, уклонение -5%.
- Щит Рун: при окончании хода с 0 ОД броня +2 до конца хода врагов.
- Каменный Ответ: получив удар >25% HP, следующий удар игнорирует 30% брони.
- Стойкая Воля: на полном HP в начале хода +1 ОД (не выше капа).
- Рывок Чести: при HP ≤ 1/3 1-я атака в ход стоит 0 ОД и точность +25%.

### Берсерк
- HP +10, броня -1, уклонение без изменений.
- Кровавая ярость I (HP 70-100%): урон +10%.
- Кровавая ярость II (HP 40-69%): урон +25%.
- Кровавая ярость III (HP 20-39%): урон +45%.
- Кровавая ярость IV (HP 1-19%): урон +65%.
- Кровавая добыча: первое убийство за ход восстанавливает 1 ОД.
- Неистовая живучесть: первый смертельный удар за игру отменяет смерть и полностью восстанавливает HP.
- Сытая ярость: каждый кусок мяса даёт +30% к точности на 1 ход.

### Ассасин
- HP -4, броня -1, уклонение +10%, точность +5%.
- Безупречный удар: при полном HP урон +40%.
- Последняя тень: при HP ≤ 1/3 игнор брони и уклонения цели.
- Эхо убийства: первое убийство за ход наносит 50% урона всем врагам.
- Клинок в спину: первая атака по цели с полным HP наносит +20% урона.
- Мастер зельеварения: зелья дают +2 HP.

### Охотник
- HP +2, броня без изменений, уклонение +5%, точность +10%.
- Охотничья метка: первая атака по цели накладывает метку.
- Добыча: по цели с меткой урон +25%.
- Перенос метки: при убийстве цели метка переходит на случайного врага из первых ceil(N/2).
- Гон по следу: первое убийство за ход восстанавливает 1 ОД.
- Выверенный выстрел: первая атака в ход получает +10% точности.
- На последнем издыхании: при HP ≤ 1/3 точность 100%.

### Палач
- HP +4, броня +1, уклонение -5%, точность без изменений.
- Точность мясника: если оружие накладывает кровотечение, шанс +20% (макс. 100%).
- Вытяжка мученика: зелья лечения для Палача переименованы, сильные недоступны.
- Жатва: по кровоточащим целям урон +25%.
- Приговор: убийство кровоточащего врага лечит 5 HP (до 2 раз за ход).
- Натиск: если есть кровотечение, следующая атака в ход получает +1 ОД.
- На последнем издыхании: при HP ≤ 1/3 точность 100%.
- Цена смерти: после 3 ходов на последнем издыхании получает -10 HP.

### Дуэлянт
- HP без изменений, броня без изменений, уклонение +10%, точность +5%.
- Дуэль: при 1 живом враге урон +25% и точность +15%.
- Парирование: первый успешный удар врага в фазу снижает урон на 30% и контратакует на 50% предотвращенного урона.
- Клинок чести: первая атака в ход игнорирует 25% брони цели.
- Дуэльная зона: 2 заряда на этаж, при использовании на враге активирует эффект дуэли на 2 хода или до его смерти.
- На последнем издыхании: при HP ≤ 1/3 точность 100%.

## Личный кабинет
- Имя игрока и дата регистрации.
- Текущий сезон и место в рейтинге сезона.
- Сезонная статистика: убийства, сундуки, сокровища.
- Общая статистика за все время.
- Опыт, уровень и прогресс-бар до следующего уровня.
- Претендуемые награды сезона, награды прошлого сезона, история наград (стекается) и вечные награды.

## Стек
- Python 3.11+
- aiogram 3.x
- SQLite (aiosqlite)

## Запуск
1) Создать бота и получить токен у BotFather.
2) Экспортировать токен:

```bash
export BOT_TOKEN="<token>"
```

3) Установить зависимости и запустить:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m bot.main
```

## Docker
1) Создать файл `.env` в корне проекта:

```bash
BOT_TOKEN="<token>"
ADMIN_IDS="123,456"
```

2) Создать файл базы на хосте:

```bash
touch ruins.db
```

3) Собрать и запустить контейнер:

```bash
docker compose up -d --build
```

4) База данных хранится на хосте в `./ruins.db` (файл сохраняется при перезапуске контейнера).

## Структура данных (SQLite)
- `users`: id, telegram_id, username, max_floor, xp, created_at
- `runs`: id, user_id, started_at, ended_at, max_floor, is_active, state_json
- `user_stats`: общая статистика игрока (забеги, смерти, убийства, сундуки, сокровища)
- `user_broadcasts`: какие рассылки получал игрок
- `settings`: служебные настройки (последний обработанный сезон и т.д.)
- `seasons`: season_key, started_at, ended_at
- `user_season_stats`: сезонная статистика игроков (max_floor, убийства, сундуки, сокровища, смерти, xp_gained)
- `user_badges`: награды игрока (стекаются для сезонных наград)
- `season_history`: история завершенных сезонов (победители и сводка)

## Формат данных (JSON)

### data/enemies.json
- id - уникальный идентификатор врага.
- name - отображаемое имя.
- base_hp - базовое HP, к которому прибавляется рост по этажам.
- base_attack - базовый урон, к которому прибавляется рост по этажам.
- base_armor - базовая броня, к которой прибавляется рост по этажам.
- base_accuracy - базовая точность врага (дальше увеличивается по этажам).
- base_evasion - базовое уклонение врага (дальше увеличивается по этажам).
- hp_per_floor - прибавка HP за этаж.
- attack_per_floor - прибавка урона за этаж.
- armor_per_floor - прибавка брони за этаж.
- group_min - минимальный размер группы (зарезервировано).
- group_max - максимальный размер группы (зарезервировано).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.
- danger - текстовая оценка опасности.
- info - короткая справка в бою.
- traits - список особых свойств врага (например, shadow_blade, stone_skin, true_strike).

### data/weapons.json
- id - уникальный идентификатор оружия.
- name - отображаемое имя.
- min_dmg - минимальный урон.
- max_dmg - максимальный урон.
- accuracy_bonus - бонус к точности (может быть отрицательным).
- splash_ratio - доля урона, которая наносится до трёх другим живым врагам.
- bleed_chance - шанс наложить кровотечение.
- bleed_damage - урон кровотечения за ход.
- armor_pierce - доля брони, игнорируемая ударом (0.2 = 20%).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.
- level - базовый уровень оружия для масштабирования в наградах.

### data/chest_loot.json
- type - тип награды: weapon, upgrade или scroll.
- id - идентификатор предмета (оружие или улучшение).
- min_floor - минимальный этаж, с которого может выпасть.
- max_floor - максимальный этаж (если не задан, считается 999).

### data/scrolls.json
- id - уникальный идентификатор свитка.
- name - отображаемое имя.
- element - тип магии: fire, ice или lightning.
- desc - короткое описание эффекта.


### data/upgrades.json
- id - уникальный идентификатор улучшения.
- name - отображаемое имя.
- type - тип улучшения: stat или potion.
- stat - имя характеристики (только для stat): hp_max, ap_max, accuracy, evasion, armor, power, luck.
- amount - величина изменения характеристики (только для stat).
- heal - восстановление HP (только для potion).
- ap_restore - восстановление ОД (только для potion).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.

## Формулы

### Шанс попадания
```text
effective_evasion = defender_evasion
if enemy.evasion_pierce > 0:
    effective_evasion *= (1 - enemy.evasion_pierce)
effective_evasion = apply_evasion_reduction(effective_evasion, floor)
hit_chance = clamp(attacker_accuracy - effective_evasion, 0.15, 0.95)
```
- Для игрока: `attacker_accuracy = player.accuracy + weapon.accuracy_bonus`.
- Для врага: `attacker_accuracy = enemy.accuracy`.
- `enemy.evasion_pierce` применяется только при атаках врага.
- Для Рыцаря, Охотника, Палача и Дуэлянта состояние «на последнем издыхании» даёт точность 100% (HP ≤ 1/3 от максимального).
- Некромант, Дочь некроманта, Проклятый Слепой охотник и Проклятый Клинок тени не промахиваются.
- Поздний босс гарантированно попадает каждый второй удар.

### Приглушение уклонения (50+ этаж)
```text
reduction = min(0.25, 0.003 * (floor - 50))
effective_evasion = evasion * (1 - reduction)
```

### Лимит ОД по этажу
```text
ap_cap = 4 + 2 * (floor // 10)
```
- Апгрейды ОД сверх лимита не предлагаются.
- Если `ap_max` уже выше лимита, он временно режется до капа.

### Урон игрока
```text
base_damage = rand(weapon.min_dmg, weapon.max_dmg) + player.power
effective_armor = target.armor * (1 - weapon.armor_pierce)
reduced_portion = base_damage * 0.7 - effective_armor
bypass_portion = base_damage * 0.3
damage = max(1, round(max(0, reduced_portion) + bypass_portion))
```

### Решимость (Рыцарь, полное здоровье)
```text
final_damage *= 1.2
```
- Активна у Рыцаря, когда HP == hp_max.

### Сплэш-урон
```text
splash_damage = max(1, int(damage * weapon.splash_ratio))
```
Применяется к трём остальным живым врагам.

### Кровотечение
```text
if rand() < weapon.bleed_chance:
    target.bleed_turns = max(target.bleed_turns, 2)
    target.bleed_damage = max(target.bleed_damage, weapon.bleed_damage)

# Каждый ход врага
if target.bleed_turns > 0:
    target.hp -= target.bleed_damage
    target.bleed_turns -= 1
```

### Урон врага
```text
effective_armor = player.armor * (1 - enemy.armor_pierce)
reduced_portion = enemy.attack * 0.7 - effective_armor
bypass_portion = enemy.attack * 0.3
damage = max(1, round(max(0, reduced_portion) + bypass_portion))
```

### Рост характеристик врага по этажам
```text
max_hp = int(base_hp + hp_per_floor * floor)
attack = base_attack + attack_per_floor * floor
armor = base_armor + armor_per_floor * floor
accuracy = clamp(base_accuracy + floor * 0.01, 0.4, 0.95)
evasion = clamp(base_evasion + floor * 0.005, 0.02, 0.3)
```

### Масштабирование оружия в наградах
```text
increase = floor - weapon.level
weapon.min_dmg += increase
weapon.max_dmg += increase
weapon.bleed_damage += increase // 2
weapon.level = floor
```

### Бонус редкости оружия (после 10 этажа)
```text
weapon.min_dmg += 2
weapon.max_dmg += 3
weapon.accuracy_bonus += 0.05
weapon.splash_ratio += 0.05
weapon.bleed_chance += 0.05
weapon.bleed_damage += 1 (если есть кровотечение)
weapon.armor_pierce += 0.05
```
Префиксы по глубине: 11+ Редкий, 20+ Эпический, 30+ Легендарный, 40+ Мифический,
50+ Древний, 60+ Реликтовый, 70+ Божественный, 80+ Вечный, 90+ Абсолютный, 100+ Апокрифический.

### Бюджет урона для генерации группы врагов
```text
ratio = 0.4 if floor <= 10 else 0.6
ratio += 0.1 * max(0, (floor - 20) // 10)
ratio = min(ratio, 1.0)
budget = player.hp_max * ratio
sum(enemy.attack) <= budget
```
Дополнительно ограничивается размер группы: 1 враг на этажах 1-3, 1-2 врага на 4-6, далее базово до 3 (в late game минимум может стать выше).

### Бронепробой врагов после 50 этажа
```text
enemy.armor_pierce = clamp(0.1 + 0.002 * (floor - 50), 0.0, 0.2)
```

### Late game (после 20 этажа)
- Каждые 10 этажей после 20 увеличивают бюджет урона врагов на +0.1.
- Минимальный размер группы врагов увеличивается на +1 каждые 10 этажей после 20.
- Правила про минимум по ОД сохраняются (если ОД 3+, минимум 2; если ОД 5+, минимум 3).
- Каждые 10 этажей после 10 появляется босс павший герой (кроме этажей, кратных 50).
- Победа над поздним боссом (павший герой) дает 1 сильное зелье лечения и +5 к макс. HP.
- На этажах 50/100/150 и далее появляется босс «Дочь некроманта».
- После 50-го уровня на обычных этажах может появиться проклятие: ОД снижаются до 3/4 (шанс 20%).
- После 50-го уровня обычные враги получают запас HP, чтобы переживать полный ход героя (без учета свитков и эффектов).
- После 50-го уровня появляются элиты: «Проклятый Клинок тени» (первый удар игрока мимо), «Проклятый Окаменелый Хранитель» (броня растет), «Проклятый Слепой охотник» (не промахивается).
- После 50-го уровня комнаты дают больше зелий (источник — малое, сундук/костер — малое и среднее).

### Сезоны и награды
- Рейтинг обновляется 1-го числа каждого месяца и строится по максимальному этажу сезона.
- Сезон 0 стартует 20.12.2025 (2025-12), далее сезон увеличивается на +1 каждый месяц.
- Сезонные награды выдаются при смене сезона и фиксируются в истории.
- Сезонные награды сохраняются в истории и могут стакаться (например, x2).
- Опыт начисляется за завершенные забеги (этажи + сокровища + испытания руин) и за сезонные награды.

### Опыт и уровни
- XP за забег = достигнутый этаж + сокровища (по 5 XP за каждое) + испытания руин (по 20 XP).
- Убийства XP не дают. Победа над Дочерью некроманта даёт +10 XP.
- XP за награды выдаётся при начислении награды (1 раз за сезон).
- Формула уровня:
```text
xp_to_next = 100 + 25 * (level - 1)
```

### Награды и опыт
- Корона Руин — место #1 в рейтинге сезона (+500 XP).
- Костяной трон — место #2 (+350 XP).
- Серебро катакомб — место #3 (+250 XP).
- Зов глубин — топ-10 сезона (+120 XP).
- Кровь руин — больше всех убийств за сезон (+180 XP).
- Собиратель праха — больше всех сундуков за сезон (+180 XP).
- Ловец реликвий — больше всех сокровищ за сезон (+180 XP).
- Легенда спуска — самый высокий этаж сезона (+220 XP).
- Несгибаемый — больше всех забегов за сезон (+150 XP).
- Первопроходец — игроки, зарегистрированные до 2026-01-01 (+100 XP).


### Шанс получить награду из сундука
```text
chance = clamp(player.luck, 0.05, 0.7)
```
Амулет удачи дает +5% к удаче, максимум удачи — 70%.
При успехе награда выбирается из пула на +2 этажа и может быть экипирована или оставлена.

### «Последнее издыхание» (точность 100%)
```text
threshold = player.hp_max / 3
```

### Магические свитки
```text
magic_damage = max(20, (weapon.max_dmg + player.power) * effective_ap_max)
```
`effective_ap_max` учитывает проклятые этажи (ОД 3/4).
- Решимость (Рыцарь, полное здоровье) усиливает урон магии на 20%.
- Магия игнорирует броню цели.
- Использование свитка тратит 1 ОД.
- Огненный свиток: наносит урон и накладывает горение на следующий ход с тем же уроном.
- Ледяной свиток: наносит урон и пропускает следующий ход цели (не стакается, работает на боссе).
- Свиток молнии: наносит полный урон всем врагам.
- Свиток молнии появляется в сундуках с 15 этажа.
- В начале забега выдаётся ледяной свиток.


### Поздний босс (павший герой)
```text
steps = max(1, (floor - 10) // 10)
max_hit = weapon.max_dmg + player.power
avg_hit = (weapon.min_dmg + weapon.max_dmg) / 2 + player.power
resolve = 1.2 if HP == hp_max else 1.0
turn_burst = max_hit * player.ap_max * resolve
min_turn_hp = turn_burst * (4 - 1) + 1

boss_hp = max(player.hp_max * 3.0, turn_burst * 1.8, min_turn_hp) * (1 + 0.12 * steps)
boss_attack = max(player.hp_max * 0.33, 12) * (1 + 0.07 * steps)
boss_armor = max(2.5, avg_hit * 0.25 / max(0.2, 1 - weapon.armor_pierce))
boss_accuracy = clamp(0.78 + 0.015 * steps, 0.70, 0.92)
boss_evasion = clamp(0.07 + 0.01 * steps, 0.05, 0.22)
boss_evasion_pierce = 0.30
boss_guaranteed_hit_every = 2
```
Награда: +5 к макс. HP и сильное зелье.

### Дочь некроманта (ультимативный босс)
```text
steps = max(1, floor // 50)
max_hit = weapon.max_dmg + player.power
avg_hit = (weapon.min_dmg + weapon.max_dmg) / 2 + player.power
resolve = 1.2 if HP == hp_max else 1.0
burst = max_hit * player.ap_max * resolve

power_mult = 1.5 + (steps - 1) * 0.5
boss_hp = max(player.hp_max * 4.5, burst * 3.0, 2000) * power_mult
boss_attack = max(player.hp_max * 0.45, 18) * power_mult
boss_attack = min(boss_attack, player.hp_max * 0.6)
boss_armor = max(4.0, avg_hit * 0.35 / max(0.2, 1 - weapon.armor_pierce)) * power_mult
boss_accuracy = clamp(0.85 + 0.02 * steps, 0.80, 0.97)
boss_evasion = clamp(0.10 + 0.015 * steps, 0.08, 0.28)
```
Промах невозможен, урон ограничен 60% от HP героя.
Награда: +5 к макс. HP, пополнение зелий до половины, свиток молнии и +10 XP.



## TODO для контента
- Добавить больше врагов, оружия и апгрейдов.
- Написать легенды/события этажей.
