# Ruins: Secret Of Death (Telegram Bot)

Телеграм-игра в жанре текстового рогалика. Один забег = одна попытка до смерти.
Цель — пройти как можно больше этажей руин и занять место в рейтинге.

## Ключевые механики
- Случайное стартовое оружие 0 этажа.
- Каждая новая лестница — случайная группа врагов с характеристиками текущего этажа.
- Бой пошаговый: враги отвечают после завершения вашего хода.
- Очки действия (ОД): тратятся на атаки/умения, полностью восстанавливаются кнопкой "Завершить ход".
- Максимум ОД ограничен по этажам: 1–9 = 4, 10–19 = 6, 20–29 = 8 (далее +2 каждые 10 этажей).
- Между этажами здоровье полностью восстанавливается только в источнике; оружие усиливается только при выборе награды.
- Оружие и враги распределены по зонам 1–3, 4–6, 7–9 этажей.
- Между этажами появляются тематические комнаты: источник благодати (полный хил), сундук древних и костер паломника (дают малое зелье).
- Амулет удачи повышает шанс получить награду из сундука на +2 этажа.
- В бою доступна кнопка "Справка" с кратким описанием противников.
- Шанс попадания: зависит от точности игрока и уклонения врага.
- Оружие может иметь эффекты (сплэш-урон по группе, кровотечение, бронебойные удары).
- Свитки магии добываются в сундуках, хранятся в инвентаре и тратят 1 ОД при использовании.
- Каждые 100 этажей появляется отдельный босс — дочь некроманта.
- Перед боссом можно выбрать артефакт: +10 к макс. HP, +1 к макс. ОД или 2 средних зелья + случайный свиток.
- После победы — выбор 1 из 3 наград (оружие, апгрейд, зелье).
- Рейтинг: максимум достигнутых этажей за все забеги.

## Стек
- Python 3.11+
- aiogram 3.x
- SQLite (aiosqlite)

## Запуск
1) Создать бота и получить токен у BotFather.
2) Экспортировать токен:

```bash
export BOT_TOKEN="<token>"
```

3) Установить зависимости и запустить:

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python -m bot.main
```

## Структура данных (SQLite)
- `users`: id, telegram_id, username, max_floor, created_at
- `runs`: id, user_id, started_at, ended_at, max_floor, is_active, state_json

## Формат данных (JSON)

### data/enemies.json
- id - уникальный идентификатор врага.
- name - отображаемое имя.
- base_hp - базовое HP, к которому прибавляется рост по этажам.
- base_attack - базовый урон, к которому прибавляется рост по этажам.
- base_armor - базовая броня, к которой прибавляется рост по этажам.
- base_accuracy - базовая точность врага (дальше увеличивается по этажам).
- base_evasion - базовое уклонение врага (дальше увеличивается по этажам).
- hp_per_floor - прибавка HP за этаж.
- attack_per_floor - прибавка урона за этаж.
- armor_per_floor - прибавка брони за этаж.
- group_min - минимальный размер группы (зарезервировано).
- group_max - максимальный размер группы (зарезервировано).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.
- danger - текстовая оценка опасности.
- info - короткая справка в бою.

### data/weapons.json
- id - уникальный идентификатор оружия.
- name - отображаемое имя.
- min_dmg - минимальный урон.
- max_dmg - максимальный урон.
- accuracy_bonus - бонус к точности (может быть отрицательным).
- splash_ratio - доля урона, которая наносится всем остальным врагам.
- bleed_chance - шанс наложить кровотечение.
- bleed_damage - урон кровотечения за ход.
- armor_pierce - доля брони, игнорируемая ударом (0.2 = 20%).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.
- level - базовый уровень оружия для масштабирования в наградах.

### data/chest_loot.json
- type - тип награды: weapon, upgrade или scroll.
- id - идентификатор предмета (оружие или улучшение).
- min_floor - минимальный этаж, с которого может выпасть.
- max_floor - максимальный этаж (если не задан, считается 999).

### data/scrolls.json
- id - уникальный идентификатор свитка.
- name - отображаемое имя.
- element - тип магии: fire, ice или lightning.
- desc - короткое описание эффекта.


### data/upgrades.json
- id - уникальный идентификатор улучшения.
- name - отображаемое имя.
- type - тип улучшения: stat или potion.
- stat - имя характеристики (только для stat): hp_max, ap_max, accuracy, evasion, armor, power, luck.
- amount - величина изменения характеристики (только для stat).
- heal - восстановление HP (только для potion).
- ap_restore - восстановление ОД (только для potion).
- min_floor - минимальный этаж появления.
- max_floor - максимальный этаж появления.

## Формулы

### Шанс попадания
```text
hit_chance = clamp(attacker_accuracy - defender_evasion, 0.15, 0.95)
```
- Для игрока: `attacker_accuracy = player.accuracy + weapon.accuracy_bonus`.
- Для врага: `attacker_accuracy = enemy.accuracy`.
- В состоянии «на последнем издыхании» точность игрока = 100% (HP ≤ 1/3 от максимального).

### Урон игрока
```text
base_damage = rand(weapon.min_dmg, weapon.max_dmg) + player.power
effective_armor = target.armor * (1 - weapon.armor_pierce)
damage = max(1, int(base_damage - effective_armor))
```

### Решимость (полное здоровье)
```text
final_damage *= 1.2
```
- Активна, когда HP == hp_max.

### Сплэш-урон
```text
splash_damage = max(1, int(damage * weapon.splash_ratio))
```
Применяется ко всем остальным живым врагам.

### Кровотечение
```text
if rand() < weapon.bleed_chance:
    target.bleed_turns = max(target.bleed_turns, 2)
    target.bleed_damage = max(target.bleed_damage, weapon.bleed_damage)

# Каждый ход врага
if target.bleed_turns > 0:
    target.hp -= target.bleed_damage
    target.bleed_turns -= 1
```

### Урон врага
```text
damage = max(1, int(enemy.attack - player.armor))
```

### Рост характеристик врага по этажам
```text
max_hp = int(base_hp + hp_per_floor * floor)
attack = base_attack + attack_per_floor * floor
armor = base_armor + armor_per_floor * floor
accuracy = clamp(base_accuracy + floor * 0.01, 0.4, 0.95)
evasion = clamp(base_evasion + floor * 0.005, 0.02, 0.3)
```

### Масштабирование оружия в наградах
```text
increase = floor - weapon.level
weapon.min_dmg += increase
weapon.max_dmg += increase
weapon.bleed_damage += increase // 2
weapon.level = floor
```

### Бюджет урона для генерации группы врагов
```text
budget = player.hp_max * ENEMY_DAMAGE_BUDGET_RATIO
sum(enemy.attack) <= budget
```
Дополнительно ограничивается размер группы: 1 враг на этажах 1-3, 1-2 врага на 4-6, до 3 врагов дальше.

### Late game (после 20 этажа)
- Каждые 10 этажей после 20 увеличивают бюджет урона врагов на +0.1.
- Минимальный размер группы врагов увеличивается на +1 каждые 10 этажей после 20.
- Правила про минимум по ОД сохраняются (если ОД 3+, минимум 2; если ОД 5+, минимум 3).
- Каждые 10 этажей после 10 появляется босс павший герой (кроме этажей 100/200/300).
- На этажах 100/200/300 и далее появляется босс «Дочь некроманта».


### Шанс получить награду из сундука
```text
chance = clamp(player.luck, 0.05, 0.7)
```

### «Последнее издыхание» (точность 100%)
```text
threshold = player.hp_max / 3
```

### Магические свитки
```text
magic_damage = max(20, (weapon.max_dmg + player.power) * player.ap_max)
```
- Магия игнорирует броню цели.
- Огненный свиток: наносит урон и накладывает горение на следующий ход с тем же уроном.
- Ледяной свиток: наносит урон и пропускает следующий ход цели (не стакается, работает на боссе).
- Свиток молнии: наносит полный урон всем врагам.


## TODO для контента
- Добавить больше врагов, оружия и апгрейдов.
- Написать легенды/события этажей.
